---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include = F}
knitr::opts_chunk$set(
  echo = T, message = F, warning = F, eval=F
)
```

# Analyzing traffic with Google Analytics {#google-analytics}

This chapter shows you how to embed Google Analytics on your website to capture traffic from users. Additionally, this chapter will provide some guidance on how to analyze traffic using the R package [googleAnalyticsR](https://code.markedmondson.me/googleAnalyticsR/).

If you haven't already, complete the following prerequisites:

- [Create your blogdown website](#create-site-with-theme) and (optionally) [add some content](#content)
- [Deploy your site on Netlify](#deploy)
- [Sign up for Google Analytics](#create-accounts)

## How it works

Once you sign up for Google Analytics, the main objectives are to create an Account and a Property for your website domain name, then obtain a Tracking ID. This tracking code will go in the `config.yaml` file on your website, which in turn will instruct Google Analytics to collect the data on user traffic to your website.

## Setting up Google Analytics

Follow these steps to integrate Google Analytics into your website:

1. Sign in to Google Analytics and navigate to Admin > Create Account. [Example](https://i.imgur.com/QRTa07k.png)

2. Under Account setup, provide an appropriate name (e.g. personal-website) and configure the Account Data Sharing Settings to your liking. The defaults should be fine. Click "Next".

3. Under Property setup, provide an appropriate name (e.g. personal-website-property). 

4. Under Property setup, click on "Show advanced options" to create a Universal Analytics property. For the Website URL, provide the URL to your website. Click "Next". [Example](https://i.imgur.com/0jffYnF.png)

5. Under About you business, configure the settings to your liking. Click "Next" and accept the terms of service.

6. Locate the Tracking ID by returning back to the Admin console and selecting the Account and Property that were created in the previous steps. **Important:** Make sure you locate the Universal Analytics property that reads `property name (UA-XXXXXXX-X)` and not the GA4 property. Under Property, click on Tracking Info > Tracking Code ([example](https://i.imgur.com/GtiKfhq.png)). Copy the Tracking ID, which should appear in the form of UA-XXXXXXXXX-1. [Example](https://i.imgur.com/qcyaVBD.png)

7. Return to your RStudio Project where you are developing your website. Open the file `config.yaml` in the main directory and locate the `googleAnalytics:` parameter. Depending on the theme, this parameter may be written or spelled slightly differently. Paste your Google Analytics Tracking ID here, e.g. `googleAnalytics: 'UA-XXXXXXXXX-1'`. [Example](https://i.imgur.com/xgN24ah.png).

8. Push your changes to your GitHub repository to complete the Google Analytics integration.

## Analyzing traffic using googleAnalyticsR

[googleAnalyicsR](https://code.markedmondson.me/googleAnalyticsR/) is an R package for analyzing Google Analytics data stemming from traffic to your website.

### Install the package

```{r, eval = F}
install.packages("googleAnalyticsR", dependencies = TRUE)
```

### Authenticate your Google Analytics account

```{r}
library(googleAnalyticsR)

ga_auth(email="usc00@hotmail.com")
```

### Load packages for data analytics

```{r}
library(dplyr)
library(plotly)
library(DT)
library(leaflet)
```

### List your Google Analytics accounts and properties

```{r}
## get your accounts
ga_accounts <- ga_account_list()

ga_accounts
```

### Obtain viewId associated with your website

```{r}
view_id <- ga_accounts %>%
  filter(accountName == "abndistro", webPropertyName == "Abnormal Distributions") %>%
  pull(viewId)
```

### Daily count of website users

```{r}
daily_users <- google_analytics(
  viewId = view_id,
  date_range = c("2019-01-01", "2020-12-31"),
  metrics = "users",
  dimensions = "date"
) %>%
  as_tibble()

plot_ly(
  data = daily_users,
  x = ~date,
  y = ~users,
  mode = "lines"
) %>%
  layout(title = "Daily count of users who engaged with Abnormal Distributions")
```

### Users by device type

```{r}
users_by_device_type <- google_analytics(
  viewId = view_id,
  date_range = c("2019-01-01", "2020-12-31"),
  metrics = "users",
  dimensions = "deviceCategory"
) %>%
  as_tibble()

plot_ly(
  data = users_by_device_type,
  x = ~deviceCategory,
  y = ~users,
  type = "bar"
) %>%
  layout(title = "Users by device type")
```

### Page views by page

```{r}
page_views <- google_analytics(
  viewId = view_id,
  date_range = c("2019-01-01", "2020-12-31"),
  metrics = "pageviews",
  dimensions = "pageTitle"
) %>%
  as_tibble()

page_views %>%
  arrange(desc(pageviews)) %>%
  DT::datatable()
```

### Users by location

```{r}
users_location <- google_analytics(
  viewId = view_id,
  date_range = c("2019-01-01", "2020-12-31"),
  metrics = "users",
  dimensions = c("latitude", "longitude"),
  anti_sample = T
) %>%
  as_tibble() %>%
  mutate_at(vars(latitude, longitude), list(as.numeric))

users_location %>%
  leaflet() %>% 
  addTiles() %>%
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    radius = ~log(users),
    stroke = FALSE, 
    fillOpacity = 0.5
  )
```





